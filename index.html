<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Sistema de Pedidos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: #f8f9fa;
            color: #333;
            padding-bottom: 80px;
        }
        .container {
            margin-top: 30px;
        }
        .product-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            text-align: center;
            height: 100%;
        }
        .product-card:hover {
            transform: scale(1.03);
        }
        .product-card img {
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            height: 150px;
            object-fit: cover;
            width: 100%;
        }
        .cart-summary {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            padding: 20px;
            z-index: 999;
        }
        .cart-count {
            position: absolute;
            top: -10px;
            right: -10px;
            background: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        #pedido-animation {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="text-center my-4">Menú de Productos</h1>
        <div class="row" id="products-list">
            </div>

        <div class="cart-summary">
            <h5>Mi Pedido <span class="cart-count" id="cart-item-count">0</span></h5>
            <ul class="list-group" id="cart-list">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Cesta vacía
                </li>
            </ul>
            <hr>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <strong>Total:</strong>
                <span id="cart-total">$0.00</span>
            </div>
            <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#modalConfirmarPedido">Confirmar Pedido</button>
            <button class="btn btn-secondary w-100 mt-2" data-bs-toggle="modal" data-bs-target="#modalVerPedidos">Ver mis Pedidos</button>
        </div>

    </div>

    <div class="modal fade" id="modalConfirmarPedido" tabindex="-1" aria-labelledby="modalConfirmarPedidoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalConfirmarPedidoLabel">Confirmar Pedido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="confirm-type-selection">
                        <p>¿Eres un cliente nuevo o antiguo?</p>
                        <button class="btn btn-primary" id="btn-cliente-antiguo">Cliente Antiguo</button>
                        <button class="btn btn-success" id="btn-cliente-nuevo">Cliente Nuevo</button>
                    </div>

                    <form id="formClienteAntiguo" class="d-none">
                        <p>Ingresa tu número de documento para validar tus datos.</p>
                        <div class="mb-3">
                            <label for="docAntiguo" class="form-label">Número de Documento</label>
                            <input type="text" class="form-control" id="docAntiguo" required>
                        </div>
                        <button type="button" class="btn btn-primary w-100" id="btn-validar-cliente-antiguo">Validar</button>
                        <hr>
                        <div id="cliente-antiguo-info" class="d-none">
                            <h6>Datos del Cliente</h6>
                            <div class="mb-3">
                                <label for="nombreAntiguo" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="nombreAntiguo" required>
                            </div>
                            <div class="mb-3">
                                <label for="direccionAntiguo" class="form-label">Dirección</label>
                                <input type="text" class="form-control" id="direccionAntiguo" required>
                            </div>
                            <div class="mb-3">
                                <label for="telefonoAntiguo" class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="telefonoAntiguo" required>
                            </div>
                            <button type="submit" class="btn btn-success w-100">Confirmar y Enviar Pedido</button>
                        </div>
                    </form>

                    <form id="formClienteNuevo" class="d-none">
                        <p>Ingresa tus datos para registrarte y confirmar tu pedido.</p>
                        <div class="mb-3">
                            <label for="docNuevo" class="form-label">Número de Documento</label>
                            <input type="text" class="form-control" id="docNuevo" required>
                        </div>
                        <div class="mb-3">
                            <label for="nombreNuevo" class="form-label">Nombre Completo</label>
                            <input type="text" class="form-control" id="nombreNuevo" required>
                        </div>
                        <div class="mb-3">
                            <label for="direccionNuevo" class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="direccionNuevo" required>
                        </div>
                        <div class="mb-3">
                            <label for="telefonoNuevo" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="telefonoNuevo" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Registrar y Confirmar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalVerPedidos" tabindex="-1" aria-labelledby="modalVerPedidosLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalVerPedidosLabel">Ver Mis Pedidos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Ingresa tu número de documento para validar la información de tus pedidos.</p>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="Número de Documento" id="documentoBusquedaPedidos">
                        <button class="btn btn-primary" type="button" id="btnBuscarPedidos">Buscar</button>
                    </div>
                    <hr>
                    <div id="historial-pedidos-body">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="modalResena" tabindex="-1" aria-labelledby="modalResenaLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalResenaLabel">Califica y Comenta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formResena">
                        <input type="hidden" id="resena-documento">
                        <input type="hidden" id="resena-fecha">
                        <div class="mb-3">
                            <label for="ratingResena" class="form-label">Calificación</label>
                            <select class="form-select" id="ratingResena">
                                <option value="1">⭐</option>
                                <option value="2">⭐⭐</option>
                                <option value="3">⭐⭐⭐</option>
                                <option value="4">⭐⭐⭐⭐</option>
                                <option value="5">⭐⭐⭐⭐⭐</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="comentarioResena" class="form-label">Comentario</label>
                            <textarea class="form-control" id="comentarioResena" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="enviarResena()">Enviar Reseña</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="modalProductoInfo" tabindex="-1" aria-labelledby="modalProductoInfoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalProductoInfoLabel">Detalles del Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <img id="producto-info-img" src="" alt="Imagen del Producto" class="img-fluid mb-3" style="max-height: 200px; object-fit: cover;">
                        <h4 id="producto-info-nombre"></h4>
                        <p id="producto-info-descripcion"></p>
                        <h5 class="text-primary" id="producto-info-precio"></h5>
                        <hr>
                        <h6>Reseñas y Calificaciones</h6>
                        <div id="producto-info-resenas">
                            <p>No hay reseñas para este producto.</p>
                        </div>
                    </div>
                </div> 
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>


    <div id="loading-overlay" class="d-none">
        <div id="pedido-animation" class="d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <h4 class="mt-3">En construcción de tu pedido...</h4>
        </div>
        <div id="success-animation" class="d-none">
            <div class="text-success" style="font-size: 4rem;">
                <i class="fas fa-check-circle"></i>
            </div>
            <h4 class="mt-3">¡Pedido enviado!</h4>
        </div>
    </div> 
  
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzKptINy2l2Ddc9JgBDPy0is4Z-IMG5nroRPOwRyABDJ2sIbiFwS_gEaDlC1Pjp8RQ/exec';
            
            const productsList = document.getElementById('products-list');
            const cartList = document.getElementById('cart-list');
            const cartTotalSpan = document.getElementById('cart-total');
            const cartItemCountSpan = document.getElementById('cart-item-count');
            const loadingOverlay = document.getElementById('loading-overlay');
            const pedidoAnimation = document.getElementById('pedido-animation');
            const successAnimation = document.getElementById('success-animation');
            const historialPedidosBody = document.getElementById('historial-pedidos-body');

            const btnClienteAntiguo = document.getElementById('btn-cliente-antiguo');
            const btnClienteNuevo = document.getElementById('btn-cliente-nuevo');
            const btnValidarClienteAntiguo = document.getElementById('btn-validar-cliente-antiguo');
            const formClienteAntiguo = document.getElementById('formClienteAntiguo');
            const formClienteNuevo = document.getElementById('formClienteNuevo');
            const confirmTypeSelection = document.getElementById('confirm-type-selection');
            const clienteAntiguoInfo = document.getElementById('cliente-antiguo-info');

            let cart = [];
            let allProducts = [];

            function showLoading(message, isSuccess = false) {
                loadingOverlay.classList.remove('d-none');
                pedidoAnimation.classList.add('d-none');
                successAnimation.classList.add('d-none');

                if (isSuccess) {
                    successAnimation.classList.remove('d-none');
                    document.querySelector('#success-animation h4').innerText = message;
                } else {
                    pedidoAnimation.classList.remove('d-none');
                    document.querySelector('#pedido-animation h4').innerText = message;
                }
            }

            function hideLoading() {
                loadingOverlay.classList.add('d-none');
            }

            async function sendData(action, data) {
                showLoading('Enviando solicitud...', false);
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8',
                        },
                        body: JSON.stringify({ action, data }),
                    });
                    return await response.json();
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error de conexión con el servidor.');
                    return { success: false };
                } finally {
                    hideLoading();
                }
            }

            function renderProducts(products) {
                allProducts = products;
                productsList.innerHTML = '';
                products.forEach(product => {
                    const productHtml = `
                        <div class="col-md-4 mb-4">
                            <div class="card product-card">
                                <img src="${product.imagenUrl}" class="card-img-top" alt="${product.nombre}">
                                <div class="card-body">
                                    <h5 class="card-title">${product.nombre}</h5>
                                    <p class="card-text">$${product.precio}</p>
                                    <button class="btn btn-info btn-sm" onclick="showProductInfo(${product.id})">Más info</button>
                                    <button class="btn btn-primary btn-sm add-to-cart" data-id="${product.id}">Añadir</button>
                                </div>
                            </div>
                        </div>
                    `;
                    productsList.innerHTML += productHtml;
                });
            }

            function renderCart() {
                cartList.innerHTML = '';
                let total = 0;
                let itemCount = 0;
                if (cart.length === 0) {
                    cartList.innerHTML = '<li class="list-group-item d-flex justify-content-between align-items-center">Cesta vacía</li>';
                } else {
                    cart.forEach(item => {
                        const itemTotal = item.cantidad * item.precio;
                        total += itemTotal;
                        itemCount += item.cantidad;
                        const itemHtml = `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ${item.nombre} (x${item.cantidad}) - $${item.precio}
                                <button class="btn btn-danger btn-sm" onclick="removeFromCart(${item.id})">x</button>
                            </li>
                        `;
                        cartList.innerHTML += itemHtml;
                    });
                }
                cartTotalSpan.innerText = `$${total.toFixed(2)}`;
                cartItemCountSpan.innerText = itemCount;
            }

            window.addToCart = function(id) {
                const product = allProducts.find(p => p.id == id);
                if (!product) return;
                
                const existingItem = cart.find(item => item.id == id);
                if (existingItem) {
                    existingItem.cantidad++;
                } else {
                    cart.push({ id, nombre: product.nombre, precio: parseFloat(product.precio), cantidad: 1 });
                }
                renderCart();
            }

            window.removeFromCart = function(id) {
                const existingItemIndex = cart.findIndex(item => item.id == id);
                if (existingItemIndex !== -1) {
                    cart.splice(existingItemIndex, 1);
                }
                renderCart();
            }

            // Event Listeners para el modal de confirmación de pedido
            btnClienteAntiguo.addEventListener('click', () => {
                confirmTypeSelection.classList.add('d-none');
                formClienteNuevo.classList.add('d-none');
                formClienteAntiguo.classList.remove('d-none');
            });
            
            btnClienteNuevo.addEventListener('click', () => {
                confirmTypeSelection.classList.add('d-none');
                formClienteAntiguo.classList.add('d-none');
                formClienteNuevo.classList.remove('d-none');
            });

            btnValidarClienteAntiguo.addEventListener('click', async () => {
                const documento = document.getElementById('docAntiguo').value;
                if (!documento) {
                    alert('Por favor, ingresa tu número de documento.');
                    return;
                }

                const response = await sendData('getClientByDocument', { documento });
                if (response.success) {
                    const client = response.data;
                    document.getElementById('nombreAntiguo').value = client.nombre;
                    document.getElementById('direccionAntiguo').value = client.direccion;
                    document.getElementById('telefonoAntiguo').value = client.telefono;
                    clienteAntiguoInfo.classList.remove('d-none');
                } else {
                    alert(response.error);
                }
            });

            formClienteAntiguo.addEventListener('submit', async function(e) {
                e.preventDefault();
                const documento = document.getElementById('docAntiguo').value;
                const nombre = document.getElementById('nombreAntiguo').value;
                const direccion = document.getElementById('direccionAntiguo').value;
                const telefono = document.getElementById('telefonoAntiguo').value;

                if (cart.length === 0) {
                    alert('Tu canasta está vacía. Agrega productos para continuar.');
                    return;
                }
                
                showLoading('En construcción de tu pedido...', false);
                const response = await sendData('createOrderAndModifyClient', {
                    documento, nombre, direccion, telefono,
                    pedido: cart.map(item => ({ nombre: item.nombre, cantidad: item.cantidad })),
                    total: parseFloat(cartTotalSpan.innerText.replace('$', ''))
                });

                if (response.success) {
                    showLoading('Pedido enviado!', true);
                    setTimeout(() => {
                        hideLoading();
                        bootstrap.Modal.getInstance(document.getElementById('modalConfirmarPedido')).hide();
                        cart = [];
                        renderCart();
                    }, 2000);
                } else {
                    alert(response.error);
                    hideLoading();
                }
            });

            formClienteNuevo.addEventListener('submit', async function(e) {
                e.preventDefault();
                const data = {
                    documento: document.getElementById('docNuevo').value,
                    nombre: document.getElementById('nombreNuevo').value,
                    direccion: document.getElementById('direccionNuevo').value,
                    telefono: document.getElementById('telefonoNuevo').value,
                    pedido: cart.map(item => ({ nombre: item.nombre, cantidad: item.cantidad })),
                    total: parseFloat(cartTotalSpan.innerText.replace('$', ''))
                };

                if (cart.length === 0) {
                    alert('Tu canasta está vacía. Agrega productos para continuar.');
                    return;
                }
                
                showLoading('En construcción de tu pedido...', false);
                const response = await sendData('createOrderAndRegisterClient', data);
                if (response.success) {
                    showLoading('Pedido enviado!', true);
                    setTimeout(() => {
                        hideLoading();
                        bootstrap.Modal.getInstance(document.getElementById('modalConfirmarPedido')).hide();
                        cart = [];
                        renderCart();
                    }, 2000);
                } else {
                    alert(response.error);
                    hideLoading();
                }
            });

            document.getElementById('btnBuscarPedidos').addEventListener('click', async function() {
                const documento = document.getElementById('documentoBusquedaPedidos').value;
                if (!documento) {
                    alert('Por favor, ingresa tu número de documento.');
                    return;
                }

                const response = await sendData('getSalesAndClientByDocument', { documento });
                
                historialPedidosBody.innerHTML = '';

                if (response.success) {
                    if (response.data.sales.length > 0) {
                        const clientInfo = response.data.client;
                        historialPedidosBody.innerHTML += `
                            <div class="card mb-3 bg-light">
                                <div class="card-body">
                                    <h5 class="card-title">Información del Cliente</h5>
                                    <p><strong>Nombre:</strong> ${clientInfo.nombre}</p>
                                    <p><strong>Documento:</strong> ${clientInfo.documento}</p>
                                    <p><strong>Dirección:</strong> ${clientInfo.direccion}</p>
                                    <p><strong>Teléfono:</strong> ${clientInfo.telefono}</p>
                                    <p class="text-success"><strong>Compras realizadas:</strong> ${clientInfo.compras}</p>
                                </div>
                            </div>
                            <hr>
                            <h6>Historial de Pedidos</h6>
                        `;

                        response.data.sales.forEach(sale => {
                            let pedidoText = Array.isArray(sale.pedido) ? sale.pedido.map(item => `${item.nombre} (x${item.cantidad})`).join(', ') : 'Error en el formato del pedido';
                            const pedidoHtml = `
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">Pedido del ${new Date(sale.fecha).toLocaleString()}</h6>
                                        <p class="card-text"><strong>Productos:</strong> ${pedidoText}</p>
                                        <p class="card-text"><strong>Total:</strong> $${sale.total}</p>
                                        <p class="card-text"><strong>Estado:</strong> <span class="badge bg-info">${sale.estado}</span></p>
                                        <p class="card-text"><strong>Calificación:</strong> ${sale.rating || 'Sin calificar'}</p>
                                        <p class="card-text"><strong>Comentario:</strong> ${sale.comentario || 'Sin comentario'}</p>
                                        <button class="btn btn-sm btn-warning" onclick="mostrarModalResena('${sale.cliente}', '${sale.fecha}')">Calificar y Comentar</button>
                                    </div>
                                </div>
                            `;
                            historialPedidosBody.innerHTML += pedidoHtml;
                        });
                    } else {
                        historialPedidosBody.innerHTML = '<p class="text-danger">No se encontraron pedidos con ese número de documento.</p>';
                    }
                } else {
                    historialPedidosBody.innerHTML = `<p class="text-danger">${response.error}</p>`;
                }
            });


            window.showProductInfo = async function(id) {
                const response = await sendData('getProductDetails', { id });
                if (response.success) {
                    const product = response.data.product;
                    const reviews = response.data.reviews;
                    
                    document.getElementById('producto-info-img').src = product.imagenUrl;
                    document.getElementById('producto-info-nombre').innerText = product.nombre;
                    document.getElementById('producto-info-descripcion').innerText = product.descripcion;
                    document.getElementById('producto-info-precio').innerText = `$${product.precio}`;

                    const resenasContainer = document.getElementById('producto-info-resenas');
                    resenasContainer.innerHTML = '';
                    if (reviews.length > 0) {
                        reviews.forEach(review => {
                            resenasContainer.innerHTML += `
                                <div class="card mb-2 p-2">
                                    <p><strong>Calificación:</strong> ${'⭐'.repeat(review.rating)}</p>
                                    <p class="mb-0">${review.comentario}</p>
                                </div>
                            `;
                        });
                    } else {
                        resenasContainer.innerHTML = '<p class="text-muted">No hay reseñas para este producto.</p>';
                    }

                    new bootstrap.Modal(document.getElementById('modalProductoInfo')).show();
                } else {
                    alert(response.error);
                }
            };

            window.mostrarModalResena = function(documento, fecha) {
                document.getElementById('resena-documento').value = documento;
                document.getElementById('resena-fecha').value = fecha;
                new bootstrap.Modal(document.getElementById('modalResena')).show();
            };

            window.enviarResena = async function() {
                const documento = document.getElementById('resena-documento').value;
                const fecha = document.getElementById('resena-fecha').value;
                const rating = document.getElementById('ratingResena').value;
                const comentario = document.getElementById('comentarioResena').value;
                
                const data = { documento, fecha, rating, comentario };
                const response = await sendData('submitReview', data);
                if (response.success) {
                    alert('Reseña enviada exitosamente.');
                    bootstrap.Modal.getInstance(document.getElementById('modalResena')).hide();
                    document.getElementById('btnBuscarPedidos').click(); 
                } else {
                    alert(response.error);
                }
            };
            

            function loadProducts() {
                sendData('getProducts').then(response => {
                    if (response.success) {
                        renderProducts(response.data);
                    }
                });
            }

            loadProducts();

            productsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-cart')) {
                    const id = e.target.dataset.id;
                    addToCart(id);
                }
            });
        });

    </script>
</body>
</html>
