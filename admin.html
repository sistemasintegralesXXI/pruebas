<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: #f0f2f5;
            color: #333;
        }

        .wrapper {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: #2c004a;
            color: #fff;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100%;
            overflow-y: auto;
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
        }

        .sidebar ul li a {
            color: #fff;
            text-decoration: none;
            display: block;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            transition: background 0.3s ease;
        }

        .sidebar ul li a.active, .sidebar ul li a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .main-content {
            flex-grow: 1;
            padding: 20px;
            margin-left: 250px;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
                flex-direction: row;
                overflow-x: auto;
            }
            .sidebar h2, .sidebar ul {
                display: none;
            }
            .sidebar ul li {
                display: inline-block;
            }
            .main-content {
                margin-left: 0;
            }
        }

        .header {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .card-body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .table-responsive {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
        }

        .table {
            margin-bottom: 0;
        }
        
        .estado-venta-Pendiente {
            background-color: #0d6efd;
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .estado-venta-En-Preparacion {
            background-color: #ffc107;
            color: #000;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .estado-venta-Entregado {
            background-color: #198754;
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(to right, #4a00e0, #8e2de2);
        }

        .login-box {
            background: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }

        .modal-dialog-centered {
            display: flex;
            align-items: center;
            min-height: calc(100vh - 1rem);
        }
    </style>
</head>
<body>

<div class="login-container" id="login-screen">
    <div class="login-box">
        <h3 class="text-center mb-4">Iniciar Sesión</h3>
        <form id="login-form">
            <div class="mb-3">
                <label for="username" class="form-label">Usuario</label>
                <input type="text" class="form-control" id="username" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Contraseña</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Ingresar</button>
        </form>
    </div>
</div>

<div class="wrapper d-none" id="admin-panel">
    <nav id="sidebar" class="sidebar">
        <h2 class="text-warning">Admin Panel</h2>
        <div id="user-info" class="text-center mb-3">
            <span id="user-name" class="fw-bold"></span><br>
            <span id="user-role" class="badge bg-secondary"></span>
        </div>
        <ul class="list-unstyled components">
            <li><a href="#" data-section="dashboard" class="active"><i class="fas fa-home me-2"></i>Dashboard</a></li>
            <li><a href="#" data-section="productos"><i class="fas fa-box me-2"></i>Productos</a></li>
            <li><a href="#" data-section="ventas"><i class="fas fa-chart-line me-2"></i>Ventas</a></li>
            <li><a href="#" data-section="clientes"><i class="fas fa-users me-2"></i>Clientes</a></li>
            <li><a href="#" data-section="usuarios"><i class="fas fa-user-plus me-2"></i>Usuarios</a></li>
            <li><a href="#" data-section="historial"><i class="fas fa-history me-2"></i>Historial</a></li>
            <li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión</a></li>
        </ul>
    </nav>

    <div class="main-content">
        <div class="header">
            <h3 class="mb-0">Bienvenido, <span id="welcome-name"></span></h3>
            <div class="d-flex align-items-center">
                <div class="dropdown me-3">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="notificacionesDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-bell"></i> <span class="badge bg-danger" id="notificaciones-badge">0</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificacionesDropdown" id="notificaciones-list">
                        <li><span class="dropdown-item">No hay notificaciones</span></li>
                    </ul>
                </div>
                <button class="btn btn-dark d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar" aria-controls="sidebar" aria-expanded="false" aria-label="Toggle navigation">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>

        <div id="dashboard" class="panel-section active">
            <div class="row g-4">
                <div class="col-md-6 col-lg-3">
                    <div class="card text-white bg-primary">
                        <div class="card-body">
                            <i class="fas fa-dollar-sign fa-3x mb-2"></i>
                            <h5 class="card-title">Ventas Totales</h5>
                            <h3 id="total-sales">$0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card text-white bg-warning">
                        <div class="card-body">
                            <i class="fas fa-hourglass-start fa-3x mb-2"></i>
                            <h5 class="card-title">Pedidos Pendientes</h5>
                            <h3 id="pending-orders">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card text-white bg-info">
                        <div class="card-body">
                            <i class="fas fa-motorcycle fa-3x mb-2"></i>
                            <h5 class="card-title">En Preparación</h5>
                            <h3 id="in-preparation-orders">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <i class="fas fa-check-circle fa-3x mb-2"></i>
                            <h5 class="card-title">Pedidos Entregados</h5>
                            <h3 id="delivered-orders">0</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="productos" class="panel-section d-none">
            <div class="d-flex justify-content-between mb-3">
                <h4>Productos</h4>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCrearProducto">Crear Producto</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Descripción</th>
                            <th>Precio</th>
                            <th>Imagen URL</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="ventas" class="panel-section d-none">
            <div class="d-flex justify-content-between mb-3">
                <h4>Ventas</h4>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCrearVenta">Crear Venta</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Pedido</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Abonos</th>
                            <th>Rating</th>
                            <th>Comentario</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="sales-table-body">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="clientes" class="panel-section d-none">
            <div class="d-flex justify-content-between mb-3">
                <h4>Clientes</h4>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCrearCliente">Crear Cliente</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Fecha de Registro</th>
                            <th>Documento</th>
                            <th>Nombre</th>
                            <th>Dirección</th>
                            <th>Teléfono</th>
                            <th>Compras</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="clients-table-body">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="usuarios" class="panel-section d-none">
            <div class="d-flex justify-content-between mb-3">
                <h4>Usuarios</h4>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCrearUsuario">Crear Usuario</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Nombre</th>
                            <th>Rol</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="historial" class="panel-section d-none">
            <h4>Historial de Acciones</h4>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Acción</th>
                            <th>Detalles</th>
                            <th>Usuario</th>
                        </tr>
                    </thead>
                    <tbody id="historial-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCrearProducto" tabindex="-1" aria-labelledby="modalCrearProductoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCrearProductoLabel">Crear Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formCrearProducto">
                    <div class="mb-3">
                        <label for="nombreProducto" class="form-label">Nombre del Producto</label>
                        <input type="text" class="form-control" id="nombreProducto" required>
                    </div>
                    <div class="mb-3">
                        <label for="descripcionProducto" class="form-label">Descripción</label>
                        <textarea class="form-control" id="descripcionProducto" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="precioProducto" class="form-label">Precio</label>
                        <input type="number" class="form-control" id="precioProducto" required>
                    </div>
                    <div class="mb-3">
                        <label for="imagenProducto" class="form-label">Imagen</label>
                        <input type="file" class="form-control" id="imagenProducto" accept="image/*" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="crearProducto()">Crear</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarProducto" tabindex="-1" aria-labelledby="modalEditarProductoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarProductoLabel">Editar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarProducto">
                    <input type="hidden" id="edit-producto-id">
                    <div class="mb-3">
                        <label for="editNombreProducto" class="form-label">Nombre del Producto</label>
                        <input type="text" class="form-control" id="editNombreProducto" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDescripcionProducto" class="form-label">Descripción</label>
                        <textarea class="form-control" id="editDescripcionProducto" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editPrecioProducto" class="form-label">Precio</label>
                        <input type="number" class="form-control" id="editPrecioProducto" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="actualizarProducto()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCrearCliente" tabindex="-1" aria-labelledby="modalCrearClienteLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCrearClienteLabel">Crear Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formCrearCliente">
                    <div class="mb-3">
                        <label for="documentoCliente" class="form-label">Documento</label>
                        <input type="text" class="form-control" id="documentoCliente" required>
                    </div>
                    <div class="mb-3">
                        <label for="nombreCliente" class="form-label">Nombre del Cliente</label>
                        <input type="text" class="form-control" id="nombreCliente" required>
                    </div>
                    <div class="mb-3">
                        <label for="direccionCliente" class="form-label">Dirección</label>
                        <input type="text" class="form-control" id="direccionCliente" required>
                    </div>
                    <div class="mb-3">
                        <label for="telefonoCliente" class="form-label">Teléfono</label>
                        <input type="tel" class="form-control" id="telefonoCliente" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="crearCliente()">Crear</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarCliente" tabindex="-1" aria-labelledby="modalEditarClienteLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarClienteLabel">Editar Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarCliente">
                    <input type="hidden" id="edit-cliente-documento">
                    <div class="mb-3">
                        <label for="editNombreCliente" class="form-label">Nombre del Cliente</label>
                        <input type="text" class="form-control" id="editNombreCliente" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDireccionCliente" class="form-label">Dirección</label>
                        <input type="text" class="form-control" id="editDireccionCliente" required>
                    </div>
                    <div class="mb-3">
                        <label for="editTelefonoCliente" class="form-label">Teléfono</label>
                        <input type="tel" class="form-control" id="editTelefonoCliente" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="actualizarCliente()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCrearUsuario" tabindex="-1" aria-labelledby="modalCrearUsuarioLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCrearUsuarioLabel">Crear Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formCrearUsuario">
                    <div class="mb-3">
                        <label for="usuarioNombreUsuario" class="form-label">Nombre de Usuario</label>
                        <input type="text" class="form-control" id="usuarioNombreUsuario" required>
                    </div>
                    <div class="mb-3">
                        <label for="nombreUsuario" class="form-label">Nombre Completo</label>
                        <input type="text" class="form-control" id="nombreUsuario" required>
                    </div>
                    <div class="mb-3">
                        <label for="passwordUsuario" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="passwordUsuario" required>
                    </div>
                    <div class="mb-3">
                        <label for="rolUsuario" class="form-label">Rol</label>
                        <select class="form-select" id="rolUsuario" required>
                            <option value="Admin">Admin</option>
                            <option value="Vendedor">Vendedor</option>
                            <option value="Usuario">Usuario</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="crearUsuario()">Crear</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarUsuario" tabindex="-1" aria-labelledby="modalEditarUsuarioLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarUsuarioLabel">Editar Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarUsuario">
                    <input type="hidden" id="edit-usuario-usuario">
                    <div class="mb-3">
                        <label for="editNombreUsuario" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="editNombreUsuario" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPasswordUsuario" class="form-label">Contraseña (dejar en blanco para no cambiar)</label>
                        <input type="password" class="form-control" id="editPasswordUsuario">
                    </div>
                    <div class="mb-3">
                        <label for="editRolUsuario" class="form-label">Rol</label>
                        <select class="form-select" id="editRolUsuario" required>
                            <option value="Admin">Admin</option>
                            <option value="Vendedor">Vendedor</option>
                            <option value="Usuario">Usuario</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="actualizarUsuario()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCrearVenta" tabindex="-1" aria-labelledby="modalCrearVentaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCrearVentaLabel">Crear Nueva Venta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formCrearVenta">
                    <div class="mb-3">
                        <label for="clienteVenta" class="form-label">Cliente</label>
                        <input type="text" class="form-control" id="clienteVenta" required>
                    </div>
                    <div class="mb-3">
                        <label for="pedidoVenta" class="form-label">Pedido (Ej: [ { "nombre": "Pizza", "cantidad": 2, "precio": 15 } ])</label>
                        <textarea class="form-control" id="pedidoVenta" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="totalVenta" class="form-label">Total</label>
                        <input type="number" class="form-control" id="totalVenta" required>
                    </div>
                    <div class="mb-3">
                        <label for="estadoVenta" class="form-label">Estado</label>
                        <select class="form-select" id="estadoVenta" required>
                            <option value="Pendiente">Pendiente</option>
                            <option value="En Preparacion">En Preparación</option>
                            <option value="Entregado">Entregado</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="crearVenta()">Crear</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEliminarConfirmacion" tabindex="-1" aria-labelledby="modalEliminarConfirmacionLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEliminarConfirmacionLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ¿Estás seguro que deseas eliminar este registro?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAlerta" tabindex="-1" aria-labelledby="modalAlertaLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAlertaLabel">Alerta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalAlertaBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ** REEMPLAZA CON LA URL DE TU SCRIPT DESPLEGADO **
        // Asegúrate de que esta URL sea la correcta y la hayas desplegado
        // como una aplicación web.
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzKptINy2l2Ddc9JgBDPy0is4Z-IMG5nroRPOwRyABDJ2sIbiFwS_gEaDlC1Pjp8RQ/exec';

        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const sidebarLinks = document.querySelectorAll('.sidebar .components a');
        const panelSections = document.querySelectorAll('.panel-section');

        let idToDelete = null;
        let tipoToDelete = null;
        let currentUser = null;

        function showAlert(message) {
            document.getElementById('modalAlertaBody').innerText = message;
            const modal = new bootstrap.Modal(document.getElementById('modalAlerta'));
            modal.show();
        }

        async function sendData(action, data) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify({ action, data }),
                });
                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión con el servidor. Revisa tu script de Apps Script.');
                return { success: false };
            }
        }

        function showSection(sectionId) {
            panelSections.forEach(section => {
                section.classList.add('d-none');
            });
            document.getElementById(sectionId).classList.remove('d-none');
        }

        function updateUserInfo(user) {
            document.getElementById('user-name').innerText = user.nombre;
            document.getElementById('user-role').innerText = user.rol;
            document.getElementById('welcome-name').innerText = user.nombre;
        }

        function handleLogin(user) {
            currentUser = user;
            localStorage.setItem('user', JSON.stringify(currentUser));
            loginScreen.classList.add('d-none');
            adminPanel.classList.remove('d-none');
            updateUserInfo(currentUser);
            getDashboardData(); // Cargar datos iniciales
        }

        function handleLogout() {
            localStorage.removeItem('user');
            currentUser = null;
            loginScreen.classList.remove('d-none');
            adminPanel.classList.add('d-none');
        }

        // Event Listeners
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault(); // Previene el envío del formulario nativo

            try {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const response = await sendData('login', { usuario: username, contrasena: password });
                
                if (response.success) {
                    handleLogin(response.data);
                } else {
                    showAlert('Usuario o contraseña incorrectos.');
                }
            } catch (error) {
                console.error('Error al manejar el login:', error);
                showAlert('Ocurrió un error inesperado al intentar iniciar sesión.');
            }
        });

        logoutBtn.addEventListener('click', handleLogout);

        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                sidebarLinks.forEach(item => item.classList.remove('active'));
                e.target.classList.add('active');
                const section = e.target.dataset.section;
                showSection(section);

                switch (section) {
                    case 'dashboard':
                        getDashboardData();
                        break;
                    case 'productos':
                        getProducts();
                        break;
                    case 'ventas':
                        getSales();
                        break;
                    case 'clientes':
                        getClients();
                        break;
                    case 'usuarios':
                        getUsers();
                        break;
                    case 'historial':
                        getHistorial();
                        break;
                }
            });
        });

        // Comprobar si ya hay una sesión activa al cargar la página
        const storedUser = localStorage.getItem('user');
        if (storedUser) {
            handleLogin(JSON.parse(storedUser));
        }

        // Dashboard
        async function getDashboardData() {
            const response = await sendData('getDashboardData');
            if (response.success) {
                document.getElementById('total-sales').innerText = `$${response.data.totalSales.toFixed(2)}`;
                document.getElementById('pending-orders').innerText = response.data.pendingOrders;
                document.getElementById('in-preparation-orders').innerText = response.data.inPreparationOrders;
                document.getElementById('delivered-orders').innerText = response.data.deliveredOrders;
            }
        }

        // Productos
        async function getProducts() {
            const response = await sendData('getProducts', {});
            if (response.success) {
                const tableBody = document.getElementById('products-table-body');
                tableBody.innerHTML = '';
                response.data.forEach(product => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td>${product.nombre}</td>
                        <td>${product.descripcion}</td>
                        <td>${product.precio}</td>
                        <td><a href="${product.imagenUrl}" target="_blank">Ver imagen</a></td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="mostrarModalEditarProducto(${product.id}, '${product.nombre}', '${product.descripcion}', ${product.precio})">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="mostrarModalEliminar(${product.id}, 'producto')">Eliminar</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                showAlert(response.error);
            }
        }

        window.crearProducto = async function() {
            const nombre = document.getElementById('nombreProducto').value;
            const descripcion = document.getElementById('descripcionProducto').value;
            const precio = parseFloat(document.getElementById('precioProducto').value);
            const imagenInput = document.getElementById('imagenProducto');
            const file = imagenInput.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onloadend = async () => {
                    const base64Image = reader.result;
                    const data = { nombre, descripcion, precio, imagenBase64: base64Image };
                    const response = await sendData('createProduct', data);
                    if (response.success) {
                        showAlert('Producto creado exitosamente');
                        bootstrap.Modal.getInstance(document.getElementById('modalCrearProducto')).hide();
                        getProducts();
                    } else {
                        showAlert(response.error);
                    }
                };
                reader.readAsDataURL(file);
            } else {
                showAlert('Por favor, selecciona una imagen.');
            }
        };

        window.mostrarModalEditarProducto = function(id, nombre, descripcion, precio) {
            document.getElementById('edit-producto-id').value = id;
            document.getElementById('editNombreProducto').value = nombre;
            document.getElementById('editDescripcionProducto').value = descripcion;
            document.getElementById('editPrecioProducto').value = precio;
            new bootstrap.Modal(document.getElementById('modalEditarProducto')).show();
        };

        window.actualizarProducto = async function() {
            const id = document.getElementById('edit-producto-id').value;
            const nombre = document.getElementById('editNombreProducto').value;
            const descripcion = document.getElementById('editDescripcionProducto').value;
            const precio = parseFloat(document.getElementById('editPrecioProducto').value);
            const data = { id, nombre, descripcion, precio };
            const response = await sendData('updateProduct', data);
            if (response.success) {
                showAlert('Producto actualizado exitosamente');
                bootstrap.Modal.getInstance(document.getElementById('modalEditarProducto')).hide();
                getProducts();
            } else {
                showAlert(response.error);
            }
        };

        // Ventas
        async function getSales() {
            const response = await sendData('getSales', {});
            if (response.success) {
                const tableBody = document.getElementById('sales-table-body');
                tableBody.innerHTML = '';
                response.data.forEach(sale => {
                    let pedidoText = '';
                    if (Array.isArray(sale.pedido)) {
                        pedidoText = sale.pedido.map(item => `${item.nombre} (x${item.cantidad})`).join(', ');
                    } else {
                        pedidoText = JSON.stringify(sale.pedido); // En caso de que no sea un array
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(sale.fecha).toLocaleString()}</td>
                        <td>${sale.cliente}</td>
                        <td>${pedidoText}</td>
                        <td>$${sale.total}</td>
                        <td>
                            <select class="form-select estado-venta" data-cliente="${sale.cliente}">
                                <option value="Pendiente" ${sale.estado === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                <option value="En Preparacion" ${sale.estado === 'En Preparacion' ? 'selected' : ''}>En Preparación</option>
                                <option value="Entregado" ${sale.estado === 'Entregado' ? 'selected' : ''}>Entregado</option>
                            </select>
                        </td>
                        <td>$${sale.abonos}</td>
                        <td>${sale.rating}</td>
                        <td>${sale.comentario}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="mostrarModalEliminar('${sale.cliente}', 'venta')">Eliminar</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                document.querySelectorAll('.estado-venta').forEach(select => {
                    select.addEventListener('change', async (e) => {
                        const cliente = e.target.dataset.cliente;
                        const status = e.target.value;
                        const response = await sendData('updateSaleStatus', { cliente: cliente, status });
                        if (response.success) {
                            showAlert('Estado de venta actualizado.');
                        } else {
                            showAlert(response.error);
                        }
                    });
                });
            } else {
                showAlert(response.error);
            }
        }

        window.crearVenta = async function() {
            const cliente = document.getElementById('clienteVenta').value;
            const pedidoString = document.getElementById('pedidoVenta').value;
            const total = parseFloat(document.getElementById('totalVenta').value);
            const estado = document.getElementById('estadoVenta').value;

            try {
                const pedido = JSON.parse(pedidoString);
                const data = { cliente, pedido, total, estado, abonos: 0, rating: '', comentario: '' };
                const response = await sendData('createSale', data);
                if (response.success) {
                    showAlert('Venta creada exitosamente');
                    bootstrap.Modal.getInstance(document.getElementById('modalCrearVenta')).hide();
                    getSales();
                } else {
                    showAlert(response.error);
                }
            } catch (e) {
                showAlert('Error al crear la venta. Asegúrate de que el formato del pedido sea JSON válido (ejemplo: [ { "nombre": "Producto", "cantidad": 1, "precio": 10 } ] )');
            }
        };

        // Clientes
        async function getClients() {
            const response = await sendData('getClients', {});
            if (response.success) {
                const tableBody = document.getElementById('clients-table-body');
                tableBody.innerHTML = '';
                response.data.forEach(client => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(client.fechaRegistro).toLocaleDateString()}</td>
                        <td>${client.documento}</td>
                        <td>${client.nombre}</td>
                        <td>${client.direccion}</td>
                        <td>${client.telefono}</td>
                        <td>${client.compras}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="mostrarModalEditarCliente('${client.documento}', '${client.nombre}', '${client.direccion}', '${client.telefono}')">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="mostrarModalEliminar('${client.documento}', 'cliente')">Eliminar</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                showAlert(response.error);
            }
        }
        
        window.crearCliente = async function() {
            const documento = document.getElementById('documentoCliente').value;
            const nombre = document.getElementById('nombreCliente').value;
            const direccion = document.getElementById('direccionCliente').value;
            const telefono = document.getElementById('telefonoCliente').value;
            const data = { documento, nombre, direccion, telefono };
            const response = await sendData('createClient', data);
            if (response.success) {
                showAlert('Cliente creado exitosamente');
                bootstrap.Modal.getInstance(document.getElementById('modalCrearCliente')).hide();
                getClients();
            } else {
                showAlert(response.error);
            }
        };

        window.mostrarModalEditarCliente = function(documento, nombre, direccion, telefono) {
            document.getElementById('edit-cliente-documento').value = documento;
            document.getElementById('editNombreCliente').value = nombre;
            document.getElementById('editDireccionCliente').value = direccion;
            document.getElementById('editTelefonoCliente').value = telefono;
            new bootstrap.Modal(document.getElementById('modalEditarCliente')).show();
        };

        window.actualizarCliente = async function() {
            const documento = document.getElementById('edit-cliente-documento').value;
            const nombre = document.getElementById('editNombreCliente').value;
            const direccion = document.getElementById('editDireccionCliente').value;
            const telefono = document.getElementById('editTelefonoCliente').value;
            const data = { documento, nombre, direccion, telefono };
            const response = await sendData('updateClient', data);
            if (response.success) {
                showAlert('Cliente actualizado exitosamente');
                bootstrap.Modal.getInstance(document.getElementById('modalEditarCliente')).hide();
                getClients();
            } else {
                showAlert(response.error);
            }
        };

        // Usuarios
        async function getUsers() {
            const response = await sendData('getUsers', {});
            if (response.success) {
                const tableBody = document.getElementById('users-table-body');
                tableBody.innerHTML = '';
                response.data.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.usuario}</td>
                        <td>${user.nombre}</td>
                        <td>${user.rol}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="mostrarModalEditarUsuario('${user.usuario}', '${user.nombre}', '${user.contrasena}', '${user.rol}')">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="mostrarModalEliminar('${user.usuario}', 'usuario')">Eliminar</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                showAlert(response.error);
            }
        }
        
        window.crearUsuario = async function() {
            const usuario = document.getElementById('usuarioNombreUsuario').value;
            const contrasena = document.getElementById('passwordUsuario').value;
            const nombre = document.getElementById('nombreUsuario').value;
            const rol = document.getElementById('rolUsuario').value;
            const data = { usuario, contrasena, nombre, rol };
            const response = await sendData('createUser', data);
            if (response.success) {
                showAlert('Usuario creado exitosamente');
                bootstrap.Modal.getInstance(document.getElementById('modalCrearUsuario')).hide();
                getUsers();
            } else {
                showAlert(response.error);
            }
        };

        window.mostrarModalEditarUsuario = function(usuario, nombre, contrasena, rol) {
            document.getElementById('edit-usuario-usuario').value = usuario;
            document.getElementById('editNombreUsuario').value = nombre;
            document.getElementById('editPasswordUsuario').value = '';
            document.getElementById('editRolUsuario').value = rol;
            new bootstrap.Modal(document.getElementById('modalEditarUsuario')).show();
        };

        window.actualizarUsuario = async function() {
            const usuario = document.getElementById('edit-usuario-usuario').value;
            const nombre = document.getElementById('editNombreUsuario').value;
            const contrasena = document.getElementById('editPasswordUsuario').value;
            const rol = document.getElementById('editRolUsuario').value;
            const data = { usuario, nombre, contrasena, rol };
            const response = await sendData('updateUser', data);
            if (response.success) {
                showAlert('Usuario actualizado exitosamente');
                bootstrap.Modal.getInstance(document.getElementById('modalEditarUsuario')).hide();
                getUsers();
            } else {
                showAlert(response.error);
            }
        };

        // Historial
        async function getHistorial() {
            const response = await sendData('getHistorial', {});
            if (response.success) {
                const tableBody = document.getElementById('historial-table-body');
                tableBody.innerHTML = '';
                response.data.forEach(log => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(log.fecha).toLocaleString()}</td>
                        <td>${log.accion}</td>
                        <td>${log.detalles}</td>
                        <td>${log.usuario}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                showAlert(response.error);
            }
        }

        window.mostrarModalEliminar = function(id, tipo) {
            idToDelete = id;
            tipoToDelete = tipo;
            new bootstrap.Modal(document.getElementById('modalEliminarConfirmacion')).show();
        };
        
        document.getElementById('btnConfirmarEliminar').addEventListener('click', async () => {
            let action = '';
            let data = {};
            switch(tipoToDelete) {
                case 'producto':
                    action = 'deleteProduct';
                    data = { id: idToDelete };
                    break;
                case 'cliente':
                    action = 'deleteClient';
                    data = { documento: idToDelete };
                    break;
                case 'usuario':
                    action = 'deleteUser';
                    data = { usuario: idToDelete };
                    break;
                case 'venta':
                    action = 'deleteSale'; 
                    data = { cliente: idToDelete };
                    break;
            }
            
            if (action) {
                const response = await sendData(action, data);
                if (response.success) {
                    showAlert('Registro eliminado exitosamente');
                    bootstrap.Modal.getInstance(document.getElementById('modalEliminarConfirmacion')).hide();
                    switch(tipoToDelete) {
                        case 'producto': getProducts(); break;
                        case 'cliente': getClients(); break;
                        case 'usuario': getUsers(); break;
                        case 'venta': getSales(); break;
                    }
                } else {
                    showAlert(response.error);
                }
            }
        });
    });

</script>
</body>
</html>
