<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Sabores al Barril</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>

    <div class="d-flex" id="wrapper">
        <div class="bg-dark text-white border-end" id="sidebar-wrapper">
            <div class="sidebar-heading text-center py-4 fs-4 fw-bold text-uppercase border-bottom">Admin</div>
            <div class="list-group list-group-flush my-3">
                <a href="#dashboard" class="list-group-item list-group-item-action bg-dark text-white active">
                    <i class="bi bi-speedometer2 me-2"></i> Dashboard
                </a>
                <a href="#sales" class="list-group-item list-group-item-action bg-dark text-white">
                    <i class="bi bi-cart me-2"></i> Ventas
                </a>
                <a href="#products" class="list-group-item list-group-item-action bg-dark text-white">
                    <i class="bi bi-box-seam me-2"></i> Productos
                </a>
                <a href="#clients" class="list-group-item list-group-item-action bg-dark text-white">
                    <i class="bi bi-people me-2"></i> Clientes
                </a>
                <a href="#users" class="list-group-item list-group-item-action bg-dark text-white">
                    <i class="bi bi-person-fill-gear me-2"></i> Usuarios
                </a>
                <a href="#actions" class="list-group-item list-group-item-action bg-dark text-white">
                    <i class="bi bi-clock-history me-2"></i> Historial de Acciones
                </a>
            </div>
        </div>
        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
                <div class="container-fluid">
                    <button class="btn btn-dark" id="sidebarToggle">
                        <i class="bi bi-list"></i>
                    </button>
                    <h5 class="ms-3 mb-0">Panel de Administración</h5>
                </div>
            </nav>

            <div class="container-fluid my-4">
                <div id="dashboard-content" class="content-section">
                    <h2>Dashboard y Estadísticas</h2>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card text-white bg-primary mb-3">
                                <div class="card-header">Ventas Totales del Mes</div>
                                <div class="card-body">
                                    <h5 class="card-title" id="total-sales-dashboard">$0</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-white bg-success mb-3">
                                <div class="card-header">Pedidos Finalizados</div>
                                <div class="card-body">
                                    <h5 class="card-title" id="completed-orders-dashboard">0</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-white bg-warning mb-3">
                                <div class="card-header">Pedidos en Proceso</div>
                                <div class="card-body">
                                    <h5 class="card-title" id="pending-orders-dashboard">0</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="sales-content" class="content-section d-none">
                    <h2>Ventas</h2>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="sales-month-filter" class="form-label">Filtrar por Mes:</label>
                            <input type="month" id="sales-month-filter" class="form-control">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha</th>
                                    <th>ID Cliente</th>
                                    <th>Productos</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="sales-table-body">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="products-content" class="content-section d-none">
                    <h2>Productos</h2>
                    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#productModal">
                        Crear Producto
                    </button>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Precios</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body"></tbody>
                    </table>
                </div>

                <div id="clients-content" class="content-section d-none">
                    <h2>Clientes</h2>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Teléfono</th>
                                <th>Últimos 4 Doc.</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clients-table-body"></tbody>
                    </table>
                </div>
                
                <div id="users-content" class="content-section d-none">
                    <h2>Usuarios</h2>
                    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#userModal">
                        Crear Usuario
                    </button>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body"></tbody>
                    </table>
                </div>

                <div id="actions-content" class="content-section d-none">
                    <h2>Historial de Acciones</h2>
                    <p>Esta sección requiere lógica adicional en Apps Script para registrar cada acción (creación/edición/eliminación) en una nueva hoja de cálculo.</p>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="productModal" tabindex="-1">...</div>
    <div class="modal fade" id="userModal" tabindex="-1">...</div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
  const appsScriptURL = 'https://script.google.com/macros/s/AKfycbzmADWtM8FPsG2IIKhRO1JZ_J_rW42-nxNRPYe2MkxO1T8XbHygUbnAjUxak4WLozQ/exec'; // REEMPLAZA con la URL que obtuviste

document.addEventListener('DOMContentLoaded', () => {
    // Variables y elementos del DOM
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarWrapper = document.getElementById('wrapper');
    const navLinks = document.querySelectorAll('.list-group-item-action');
    const salesTableBody = document.getElementById('sales-table-body');
    const salesMonthFilter = document.getElementById('sales-month-filter');
    const dashboardTotalSales = document.getElementById('total-sales-dashboard');
    const dashboardCompletedOrders = document.getElementById('completed-orders-dashboard');
    const dashboardPendingOrders = document.getElementById('pending-orders-dashboard');

    let allSales = [];

    // --- Funciones de Comunicación con el Backend ---
    async function fetchData(action, payload = {}) {
        try {
            const response = await fetch(appsScriptURL, {
                method: 'POST',
                body: JSON.stringify({ action, payload }),
                headers: { 'Content-Type': 'application/json' }
            });
            return await response.json();
        } catch (error) {
            console.error('Error al comunicarse con Apps Script:', error);
            return { success: false, message: 'Error de conexión con el servidor.' };
        }
    }

    // --- Lógica de la interfaz y navegación ---
    sidebarToggle.addEventListener('click', (e) => {
        e.preventDefault();
        sidebarWrapper.classList.toggle('toggled');
    });

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('.list-group-item-action.active').classList.remove('active');
            e.target.classList.add('active');

            const sectionToShow = e.target.getAttribute('href').substring(1) + '-content';
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('d-none');
            });
            document.getElementById(sectionToShow).classList.remove('d-none');

            // Cargar datos según la sección seleccionada
            if (sectionToShow === 'sales-content') {
                loadSales();
            } else if (sectionToShow === 'products-content') {
                loadProducts();
            } else if (sectionToShow === 'clients-content') {
                loadClients();
            } else if (sectionToShow === 'users-content') {
                loadUsers();
            }
        });
    });

    // --- Lógica de la sección de Ventas ---
    async function loadSales() {
        const result = await fetchData('getSales');
        if (result.success) {
            allSales = result.data;
            renderSales(allSales);
            updateDashboard(allSales);
        } else {
            salesTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">${result.message}</td></tr>`;
        }
    }

    function renderSales(sales) {
        salesTableBody.innerHTML = '';
        if (sales.length === 0) {
            salesTableBody.innerHTML = `<tr><td colspan="7" class="text-center">No hay ventas registradas.</td></tr>`;
            return;
        }
        
        sales.forEach(sale => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${sale.IDVenta}</td>
                <td>${new Date(sale.FechaVenta).toLocaleString()}</td>
                <td>${sale.IDCliente}</td>
                <td>${formatProducts(sale.ProductosVendidos)}</td>
                <td>$${sale.Total.toLocaleString()}</td>
                <td>
                    <select class="form-select status-select" data-id="${sale.IDVenta}">
                        <option value="Pendiente" ${sale.EstadoPedido === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                        <option value="En Preparación" ${sale.EstadoPedido === 'En Preparación' ? 'selected' : ''}>En Preparación</option>
                        <option value="Enviado" ${sale.EstadoPedido === 'Enviado' ? 'selected' : ''}>Enviado</option>
                        <option value="Entregado" ${sale.EstadoPedido === 'Entregado' ? 'selected' : ''}>Entregado</option>
                        <option value="Cancelado" ${sale.EstadoPedido === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                    </select>
                </td>
                <td>
                    <button class="btn btn-sm btn-info view-details-btn" data-id="${sale.IDVenta}">Ver Detalles</button>
                </td>
            `;
            salesTableBody.appendChild(row);
        });
        
        document.querySelectorAll('.status-select').forEach(select => {
            select.addEventListener('change', (e) => {
                const id = e.target.dataset.id;
                const status = e.target.value;
                updateSaleStatus(id, status);
            });
        });
    }

    function formatProducts(products) {
        let html = '<ul class="list-unstyled mb-0">';
        for (const key in products) {
            const item = products[key];
            html += `<li>${item.name} (${item.qty})</li>`;
        }
        html += '</ul>';
        return html;
    }

    async function updateSaleStatus(id, status) {
        const payload = { id: id, status: status };
        const result = await fetchData('updateSaleStatus', payload);
        if (result.success) {
            // Actualizar la tabla sin recargar si es posible
            alert('Estado de la venta actualizado.');
        } else {
            alert('Error al actualizar el estado: ' + result.message);
        }
    }

    salesMonthFilter.addEventListener('change', (e) => {
        const selectedMonth = e.target.value;
        if (selectedMonth) {
            const filteredSales = allSales.filter(sale => {
                const saleDate = new Date(sale.FechaVenta);
                const filterDate = new Date(selectedMonth + '-01'); // Asegurarse de que el día no afecte el filtro
                return saleDate.getFullYear() === filterDate.getFullYear() && saleDate.getMonth() === filterDate.getMonth();
            });
            renderSales(filteredSales);
        } else {
            renderSales(allSales);
        }
    });

    // --- Lógica del Dashboard ---
    function updateDashboard(sales) {
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        const monthlySales = sales.filter(sale => {
            const saleDate = new Date(sale.FechaVenta);
            return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
        });

        const totalSalesAmount = monthlySales.reduce((sum, sale) => sum + parseFloat(sale.Total), 0);
        const completedOrders = monthlySales.filter(sale => sale.EstadoPedido === 'Entregado').length;
        const pendingOrders = monthlySales.filter(sale => sale.EstadoPedido === 'Pendiente' || sale.EstadoPedido === 'En Preparación').length;

        dashboardTotalSales.textContent = `$${totalSalesAmount.toLocaleString()}`;
        dashboardCompletedOrders.textContent = completedOrders;
        dashboardPendingOrders.textContent = pendingOrders;
    }
    
    // --- Lógica para otras secciones (simulada) ---
    async function loadProducts() {
      const productsTableBody = document.getElementById('products-table-body');
      productsTableBody.innerHTML = `<tr><td colspan="4" class="text-center">Cargando productos...</td></tr>`;
      const result = await fetchData('getProducts');
      // ... Lógica para renderizar los productos
    }
    async function loadClients() {
      const clientsTableBody = document.getElementById('clients-table-body');
      clientsTableBody.innerHTML = `<tr><td colspan="5" class="text-center">Cargando clientes...</td></tr>`;
      // ... Lógica para obtener y renderizar clientes
    }
    async function loadUsers() {
      const usersTableBody = document.getElementById('users-table-body');
      usersTableBody.innerHTML = `<tr><td colspan="4" class="text-center">Cargando usuarios...</td></tr>`;
      // ... Lógica para obtener y renderizar usuarios
    }

    // Cargar la vista inicial (Dashboard)
    loadSales();
});
  </script>
</body>
</html>
